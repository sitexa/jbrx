<?xml version="1.0" encoding="UTF-8"?>
<DataService xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../DataService.xsd">
	
	<!-- 加入购物车 -->
	<SQLTrans TransFlag="1" TransName="addCart" DataGroupId="writeShop">
		<SelectField OutputId="{count}">
			<OutputSQL>select count(id) from goods where id={goodsId}  and status=1</OutputSQL>
		</SelectField>
		<If Value1="{count}" Type="Integer" Operator="=" Value2="0">
			<Then>
				<Return Code="1" Info="该商品已失效" Text="该商品已失效"/>
			</Then>
		</If>
		<If Value1="{attrSn}" Type="String" Operator="EXIST">
			<Then>
				<SelectField OutputId="{count}">
					<OutputSQL>select count(attrSn) from goodsattr where attrSn={attrSn} and status=1</OutputSQL>
				</SelectField>
				<If Value1="{count}" Type="Integer" Operator="=" Value2="0">
					<Then>
						<Return Code="1" Info="商品属性已失效" Text="商品属性已失效"/>
					</Then>
				</If>		
			</Then>
		</If>
		<Update RecordCountId="{updateCount}">
			<OutputSQL>update cart set quantity=quantity+{quantity} where userId={userId} and attrSn={attrSn|''} and goodsId={goodsId}</OutputSQL>
		</Update>
		<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
			<Then>
				<Insert>
					<OutputSQL>insert into cart (id,userId,goodsId,attrSn,quantity,status,createTime) values({id},{userId},{goodsId},{attrSn|''},{quantity},1,{currentTime})</OutputSQL>
				</Insert>
			</Then>
		</If>
		<OnException>
			<Return Code="-1" Info="新增Goods数据库异常" Text="新增Goods数据库异常"/>
		</OnException>
		<Return Code="0" Info="新增Goods成功" Text="新增Goods成功"/>
	</SQLTrans>
	
	<!-- 分页查询购物车 -->
	<SQLTrans TransFlag="0" TransName="queryCartPage" DataGroupId="readShop" >
		<SelectField OutputId="{totalCount}">
			<OutputSQL>select count(*) from cart where status=1 and userId={userId} </OutputSQL>
		</SelectField>
		<SelectRecordSet OutputId="{carts}">
			<OutputSQL>
				select c.*,g.title,g.marketPrice,g.nowPrice,g.pics,ga.attrSn hasAttrSn from cart c 
				left join goods g on g.id=c.goodsId 
				LEFT JOIN goodsattr ga on ga.attrSn=c.attrSn and ga.status=1  and c.attrSn!='' where c.status=1 and c.userId={userId} and g.status=1 limit {startIndex},{pageSize}	
			</OutputSQL>		
		</SelectRecordSet>
		<OnException>
			<Return Code="-1" Text="查询Goods信息异常" Info="GoodsService.xml.queryPage(i)"></Return>
		</OnException>
		<Return Code="0" Text="查询Goods信息成功" Info="查询Goods信息成功">
			<ReturnItem FieldId="{pageNumber}" ValueId="{pageNumber}"/>
			<ReturnItem FieldId="{pageSize}" ValueId="{pageSize}"/>
			<ReturnItem FieldId="{totalCount}" ValueId="{totalCount}"/>
			<ReturnItem FieldId="{list}" ValueId="{carts}"/>
		</Return>
	</SQLTrans>	

</DataService>