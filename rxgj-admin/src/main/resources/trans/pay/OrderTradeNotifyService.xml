<?xml version="1.0" encoding="UTF-8"?>
<DataService xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="DataService.xsd">
	

	<SQLTrans TransName="insertThirdCallback" TransFlag="1" DataGroupId="writePay">
		<SelectField OutputId="{count}">
			<OutputSQL>select count(tradeSn) from thirdNotifyRecord where tradeSn={tradeSn}</OutputSQL>
		</SelectField>
		<If Value1="{count}" Type="Integer" Operator="=" Value2="1">
			<Then>
				<Return Code="0" Info="回调记录已存在" Text="回调记录已存在"/>
			</Then>
		</If>
		<Insert>
			<OutputSQL>
				insert into thirdNotifyRecord (tradeSn,thirdSn,callbackData,thirdType,money,resultCode,resultDesc,createTime) 
				values({tradeSn},{thirdSn},{callbackData},{thirdType},{money},{resultCode},{resultDesc},{createTime})
			</OutputSQL>
		</Insert>
		<OnException>
			<Return Code="-1" Info="新增三方回调数据异常" Text="新增三方回调数据异常"/>
		</OnException>
		<Return Code="0" Info="新增三方回调数据成功" Text="新增三方回调数据成功"/>
	</SQLTrans>
	
	<!-- 设置交易成功 -->
	<SQLTrans TransName="updateOrderTradeSuccess" TransFlag="1" DataGroupId="writePay">
		<!-- 设置交易状态 -->
		<Update RecordCountId="{updateCount}">
			<OutputSQL>update trade set currentStep={trade.currentStep},status={trade.newStatus},notifystatus={trade.notifystatus},scheduleTime={scheduleTime},doneTime={doneTime} where id={trade.id} and status={trade.status}</OutputSQL>
		</Update>
		<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
			<Then>
				<Return Code="1" Info="修改交易失败" Text="修改交易失败"/>
			</Then>
		</If>
		<Update RecordCountId="{updateCount}">
			<OutputSQL>update tradeDetail set status={tradeDetail.newStatus},money={tradeDetail.money},thirdSn={tradeDetail.thirdSn},resultCode={tradeDetail.resultCode},resultDesc={tradeDetail.resultDesc},doneTime={doneTime} where id={tradeDetail.id}  and status={tradeDetail.status}</OutputSQL>
		</Update>
		<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
			<Then>
				<Return Code="1" Info="修改交易详细失败" Text="修改交易详细失败"/>
			</Then>
		</If>		
		
		<!-- 插入交易进出账记录 -->
		<If Value1="{fundDetails}" Type="Boolean" Operator="EXIST">
			<Then>
				<For IndexId="{i}" FromIndex="0" Count="{fundDetails.length}">
					<Insert>
						<OutputSQL>
							insert into accountFundDetail(orderSn,subject,inUserId,outUserId,money,score,inFundType,outFundType,createTime)
							values({trade.orderSn},{fundDetails[i].subject},{fundDetails[i].inUserId},{fundDetails[i].outUserId},{fundDetails[i].money},{fundDetails[i].score},{fundDetails[i].inFundType},{fundDetails[i].outFundType},{doneTime})
						</OutputSQL>
					</Insert>
				</For>
			</Then>
		</If>		
		
		<!-- 修改出账金额 -->
		<If Value1="{fundOutChange}" Type="Boolean" Operator="EXIST">
			<Then>
				<Update RecordCountId="{updateCount}">
					<OutputSQL>update accountFund set {r:fundOutChange.fundType}={r:fundOutChange.fundType}-{fundOutChange.money},score=score-{fundOutChange.score} where userId={fundOutChange.userId} and {r:fundOutChange.fundType}>={fundOutChange.money} and score>={fundOutChange.score}</OutputSQL> 
				</Update>
				<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
					<Then>
						<Return Code="1" Info="积分或金额不足" Text="积分或金额不足"/>
					</Then>
				</If>	
			</Then>
		</If>
		<!-- 修改入账金额 -->
		<If Value1="{fundInChange}" Type="Boolean" Operator="EXIST">
			<Then>
				<Update RecordCountId="{updateCount}">
					<OutputSQL>update accountFund set {r:fundInChange.fundType}={r:fundInChange.fundType}+{fundInChange.money},score=score+{fundInChange.score} where userId={fundInChange.userId}</OutputSQL>
				</Update>
				<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
					<Then>
						<Return Code="1" Info="入账用户不存在" Text="入账用户不存在"/>
					</Then>
				</If>
			</Then>
		</If>
	
		<!-- 修改下一步骤 -->
		<If Value1="{nextStep}" Type="Boolean" Operator="EXIST">
			<Then>
				<Update RecordCountId="{updateCount}">
					<OutputSQL>update tradeDetail set status={nextStep.status},scheduleTime={nextStep.scheduleTime} where orderSn={nextStep.orderSn} and  currentStep={nextStep.currentStep}  and status=0 </OutputSQL>
				</Update>
				<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
					<Then>
						<Return Code="1" Info="修改下一步执行状态失败" Text="修改下一步执行状态失败"/>
					</Then>
				</If>
			</Then>
		</If>	
		
		
		<OnException>
			<Return Code="-1" Info="回调-修改交易订单为成功数据异常" Text="回调-修改交易订单为成功数据异常"/>
		</OnException>
		<Return Code="0" Info="回调-修改交易订单为成功完成" Text="回调-修改交易订单为成功完成"/>
	</SQLTrans>	
	
	<!-- 设置交易失败 -->
	<SQLTrans TransName="updateOrderTradeFail" TransFlag="1" DataGroupId="writePay">
		<!-- 设置交易状态 -->
		<Update RecordCountId="{updateCount}">
			<OutputSQL>update trade set currentStep={trade.currentStep},status={trade.newStatus},notifystatus={trade.notifystatus},scheduleTime={scheduleTime},doneTime={doneTime} where id={trade.id} and status={trade.status}</OutputSQL>
		</Update>
		<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
			<Then>
				<Return Code="1" Info="修改交易失败" Text="修改交易失败"/>
			</Then>
		</If>
		<Update RecordCountId="{updateCount}">
			<OutputSQL>update tradeDetail set status={tradeDetail.newStatus},thirdSn={tradeDetail.thirdSn},resultCode={tradeDetail.resultCode},resultDesc={tradeDetail.resultDesc},doneTime={doneTime} where id={tradeDetail.id}  and status={tradeDetail.status}</OutputSQL>
		</Update>
		<If Value1="{updateCount}" Type="Integer" Operator="=" Value2="0">
			<Then>
				<Return Code="1" Info="修改交易详细失败" Text="修改交易详细失败"/>
			</Then>
		</If>	
		<OnException>
			<Return Code="-1" Info="新增三方回调数据异常" Text="新增三方回调数据异常"/>
		</OnException>
		<Return Code="0" Info="新增三方回调数据成功" Text="新增三方回调数据成功"/>
	</SQLTrans>	
	
</DataService>