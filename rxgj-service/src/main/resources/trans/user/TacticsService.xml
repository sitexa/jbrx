<?xml version="1.0" encoding="UTF-8"?>
<DataService xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../DataService.xsd">

    <SQLTrans TransFlag="0" TransName="getTacticsAppList" DataGroupId="readUser" >
        <SelectField OutputId="{totalCount}">
            <OutputSQL>SELECT count(*) FROM tactics t LEFT JOIN platform p on t.platformId=p.id where t.status=1 </OutputSQL>
            <SQLIf Value1="{tacticsName}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  and t.name like '%{r:tacticsName}%'</OutputSQL></SQLThen>
            </SQLIf>
        </SelectField>
        <SelectRecordSet OutputId="{users}">
            <OutputSQL>SELECT t.id as id,t.tacticsSn as tacticsSn,t.platformId as platformId,t.name as name,t.minRate as minRate,t.day as day,t.maxRate as maxRate,t.topRisk as topRisk,p.url as url FROM tactics t LEFT JOIN platform p on t.platformId=p.id where t.status=1 </OutputSQL>
            <SQLIf Value1="{tacticsName}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  and t.name like '%{r:tacticsName}%'</OutputSQL></SQLThen>
            </SQLIf>
            <SQLIf Value1="{minRate}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  order by t.minRate {r:minRate}</OutputSQL></SQLThen>
            </SQLIf>
            <SQLIf Value1="{topRisk}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  order by t.topRisk {r:topRisk}</OutputSQL></SQLThen>
            </SQLIf>
            <OutputSQL> limit {startIndex},{pageSize}</OutputSQL>
        </SelectRecordSet>
        <OnException>
            <Return Code="-1" Text="查询异常" Info="查询异常"></Return>
        </OnException>
        <Return Code="0" Text="查询成功" Info="查询成功">
            <ReturnItem FieldId="{pageNumber}" ValueId="{pageNumber}"/>
            <ReturnItem FieldId="{pageSize}" ValueId="{pageSize}"/>
            <ReturnItem FieldId="{totalCount}" ValueId="{totalCount}"/>
            <ReturnItem FieldId="{list}" ValueId="{users}"/>
        </Return>
    </SQLTrans>

    <SQLTrans TransFlag="0" TransName="getUserTacticsCount" DataGroupId="readUser" >
        <SelectField OutputId="{count}">
            <OutputSQL>SELECT COUNT(*) FROM userTactics WHERE status=1 and userId={userId} and tacticsId={tacticsId} </OutputSQL>
        </SelectField>
        <OnException>
            <Return Code="-1" Text="查询异常" Info="查询异常"></Return>
        </OnException>
        <Return Code="0" Text="查询成功" Info="查询成功">
            <ReturnItem FieldId="{count}" ValueId="{count}"/>
        </Return>
    </SQLTrans>

    <SQLTrans TransFlag="1" TransName="followTactics" DataGroupId="writeUser">
        <SelectField OutputId="{count}">
            <OutputSQL>SELECT count(*) FROM userTactics WHERE userId={userId} and tacticsId={tacticsId} </OutputSQL>
        </SelectField>
        <If Value1="{count}" Operator="!=" Type="Long" Value2="0">
            <Then>
                <Update>
                    <OutputSQL>update userTactics set status=1,updateTime={currentTime} where userId={userId} and tacticsId={tacticsId}</OutputSQL>
                </Update>
            </Then>
            <Else>
                <SelectRecord OutputId="{tactics}">
                    <OutputSQL>select * from tactics where id={tacticsId}</OutputSQL>
                </SelectRecord>
                <Insert>
                    <OutputSQL>
                        insert into userTactics (tacticsId,userId,platformId,tacticsSn,name,minRate,maxRate,topRisk,day,status,createTime,updateTime)
                        values({tacticsId},{userId},{tactics.platformId},{tactics.tacticsSn},{tactics.name},{tactics.minRate},{tactics.maxRate},{tactics.topRisk},{tactics.day},1,{currentTime},{currentTime})
                    </OutputSQL>
                </Insert>
            </Else>
        </If>
        <OnException>
            <Return Code="-1" Info="关注异常" Text="关注异常"/>
        </OnException>
        <Return Code="0" Info="关注成功" Text="关注成功"/>
    </SQLTrans>

    <SQLTrans TransFlag="1" TransName="cancelFollowTactics" DataGroupId="writeUser">
        <Update>
            <OutputSQL>update userTactics set status=2,updateTime={currentTime} where userId={userId} and tacticsId={tacticsId}</OutputSQL>
        </Update>
        <OnException>
            <Return Code="-1" Info="取消关注异常" Text="取消关注异常"/>
        </OnException>
        <Return Code="0" Info="取消关注成功" Text="取消关注成功"/>
    </SQLTrans>

    <SQLTrans TransFlag="0" TransName="getUserTacticsList" DataGroupId="readUser" >
        <SelectField OutputId="{totalCount}">
            <OutputSQL>SELECT count(*) FROM usertactics u LEFT JOIN platform p ON u.platformId=p.id WHERE u.status=1 and u.userId={userId} </OutputSQL>
        </SelectField>
        <SelectRecordSet OutputId="{users}">
            <OutputSQL>
                SELECT u.tacticsId as id,u.tacticsSn as tacticsSn,u.platformId as platformId,u.name as name,u.minRate as minRate,u.maxRate as maxRate,u.topRisk as topRisk,u.day as day,p.url as url FROM usertactics u LEFT JOIN platform p ON u.platformId=p.id WHERE u.status=1 and u.userId={userId} limit {startIndex},{pageSize}
            </OutputSQL>
        </SelectRecordSet>
        <OnException>
            <Return Code="-1" Text="查询异常" Info="查询异常"></Return>
        </OnException>
        <Return Code="0" Text="查询成功" Info="查询成功">
            <ReturnItem FieldId="{pageNumber}" ValueId="{pageNumber}"/>
            <ReturnItem FieldId="{pageSize}" ValueId="{pageSize}"/>
            <ReturnItem FieldId="{totalCount}" ValueId="{totalCount}"/>
            <ReturnItem FieldId="{list}" ValueId="{users}"/>
        </Return>
    </SQLTrans>

    <SQLTrans TransFlag="0" TransName="getTacticsListByPlatformId" DataGroupId="readUser" >
        <SelectField OutputId="{totalCount}">
            <OutputSQL>SELECT count(*) FROM tactics t LEFT JOIN platform p on t.platformId=p.id where t.status=1 and t.platformId={platformId}</OutputSQL>
            <SQLIf Value1="{tacticsName}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  and name like '%{r:tacticsName}%'</OutputSQL></SQLThen>
            </SQLIf>
        </SelectField>
        <SelectRecordSet OutputId="{users}">
            <OutputSQL>SELECT t.id as id,t.tacticsSn as tacticsSn,t.platformId as platformId,t.name as name,t.minRate as minRate,t.day as day,t.maxRate as maxRate,t.topRisk as topRisk,p.url as url FROM tactics t LEFT JOIN platform p on t.platformId=p.id where t.status=1 and t.platformId={platformId} </OutputSQL>
            <SQLIf Value1="{minRate}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  order by t.minRate {r:minRate}</OutputSQL></SQLThen>
            </SQLIf>
            <SQLIf Value1="{topRisk}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  order by t.topRisk {r:topRisk}</OutputSQL></SQLThen>
            </SQLIf>
            <OutputSQL> limit {startIndex},{pageSize}</OutputSQL>
        </SelectRecordSet>
        <OnException>
            <Return Code="-1" Text="查询异常" Info="查询异常"></Return>
        </OnException>
        <Return Code="0" Text="查询成功" Info="查询成功">
            <ReturnItem FieldId="{pageNumber}" ValueId="{pageNumber}"/>
            <ReturnItem FieldId="{pageSize}" ValueId="{pageSize}"/>
            <ReturnItem FieldId="{totalCount}" ValueId="{totalCount}"/>
            <ReturnItem FieldId="{list}" ValueId="{users}"/>
        </Return>
    </SQLTrans>

    <SQLTrans TransFlag="0" TransName="getTacticsList" DataGroupId="readUser" >
        <SelectField OutputId="{totalCount}">
            <OutputSQL>SELECT count(*) FROM tactics WHERE status!=3 and platformId={platformId} </OutputSQL>
            <SQLIf Value1="{tacticsName}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  and name like '%{r:tacticsName}%'</OutputSQL></SQLThen>
            </SQLIf>
        </SelectField>
        <SelectRecordSet OutputId="{users}">
            <OutputSQL>SELECT * FROM tactics WHERE status!=3 and platformId={platformId} </OutputSQL>
            <SQLIf Value1="{tacticsName}" Type="String" Operator="EXIST">
                <SQLThen><OutputSQL>  and name like '%{r:tacticsName}%' </OutputSQL></SQLThen>
            </SQLIf>
            <OutputSQL> limit {startIndex},{pageSize}</OutputSQL>
        </SelectRecordSet>
        <OnException>
            <Return Code="-1" Text="查询异常" Info="查询异常"></Return>
        </OnException>
        <Return Code="0" Text="查询成功" Info="查询成功">
            <ReturnItem FieldId="{pageNumber}" ValueId="{pageNumber}"/>
            <ReturnItem FieldId="{pageSize}" ValueId="{pageSize}"/>
            <ReturnItem FieldId="{totalCount}" ValueId="{totalCount}"/>
            <ReturnItem FieldId="{list}" ValueId="{users}"/>
        </Return>
    </SQLTrans>

    <SQLTrans TransFlag="1" TransName="insertTactics" DataGroupId="writeUser">
        <Insert>
            <OutputSQL>
                insert into tactics (platformId,tacticsSn,name,minRate,maxRate,topRisk,day,status,createTime,updateTime)
                values({platformId},{tacticsSn},{name},{minRate},{maxRate},{topRisk},{day},1,{currentTime},{currentTime})
            </OutputSQL>
        </Insert>
        <OnException>
            <Return Code="-1" Info="新增异常" Text="新增异常"/>
        </OnException>
        <Return Code="0" Info="保存成功" Text="保存成功"/>
    </SQLTrans>

    <SQLTrans TransFlag="1" TransName="updateTactics" DataGroupId="writeUser">
        <Update>
            <OutputSQL>update tactics set tacticsSn={tacticsSn},name={name},minRate={minRate},maxRate={maxRate},topRisk={topRisk},day={day},updateTime={currentTime} where id={id}</OutputSQL>
        </Update>
        <OnException>
            <Return Code="-1" Info="取消关注异常" Text="取消关注异常"/>
        </OnException>
        <Return Code="0" Info="取消关注成功" Text="取消关注成功"/>
    </SQLTrans>

    <SQLTrans TransFlag="1" TransName="isUsedTactics" DataGroupId="writeUser">
        <Update>
            <OutputSQL>update tactics set status={status},updateTime={currentTime} where id={id}</OutputSQL>
        </Update>
        <OnException>
            <Return Code="-1" Info="修改异常" Text="修改异常"/>
        </OnException>
        <Return Code="0" Info="保存成功" Text="保存成功"/>
    </SQLTrans>

    <SQLTrans TransFlag="1" TransName="delTactics" DataGroupId="writeUser">
        <Update>
            <OutputSQL>update tactics set status=3,updateTime={currentTime} where id={id}</OutputSQL>
        </Update>
        <OnException>
            <Return Code="-1" Info="修改异常" Text="修改异常"/>
        </OnException>
        <Return Code="0" Info="保存成功" Text="保存成功"/>
    </SQLTrans>

</DataService>